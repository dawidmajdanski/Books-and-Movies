<!--
 - Created by Dawid MajdaÅ„ski on 12.02.2019.
 -->

<aura:component description="BM_UserOrders" controller="BM_OrderController"
                implements="forceCommunity:availableForAllPageTypes">
    <aura:attribute name="myOrders" type="Order[]"/>
    <aura:attribute name="myOrdersBackup" type="Order[]"/>
    <aura:attribute name="complaints" type="list" />
    <aura:attribute name="isOrderRolledDown" type="Boolean[]"/>
    <aura:attribute name="isCaseRolledDown" type="Boolean[]"/>
    <aura:attribute name="currentPageNum" type="Integer" default="1"/>
    <aura:attribute name="maxPageNum" type="Integer"/>
    <aura:attribute name="offset" type="Integer" default="0"/>
    <aura:attribute name="resultsOnPageSize" type="Integer" default="2"/>

    <aura:handler name="init" value="{!this}" action="{!c.init}"/>

    <c:BM_Toast aura:id="toastMsg"/>

    <div class="myOrdersContainer">

        <div class="titleMyOrders">
            {!$Label.c.My_orders_title}
        </div>

        <lightning:tabset selectedTabId="orders">
            <lightning:tab label="{!$Label.c.Orders_tab}" id="orders">
                <!-- pagination -->
                <div style="text-align: center;">
                    <div class="pagination" style="position: relative">
                        <aura:if isTrue="{!greaterthan(v.currentPageNum,1)}">
                            <a data-record="{!v.currentPageNum-1}" onclick="{!c.handlePreviousPage}">&laquo;</a>
                        </aura:if>
                        <aura:if isTrue="{!greaterthan(v.currentPageNum,4)}">
                            <a data-record="1" onclick="{!c.handlePreviousPage}">1</a>
                            <a class="revertPagination">...</a>
                        </aura:if>
                        <aura:if isTrue="{!greaterthan(v.currentPageNum,2)}">
                            <a data-record="{!v.currentPageNum-2}"
                               onclick="{!c.handlePreviousPage}">{!v.currentPageNum-2}</a>
                        </aura:if>
                        <aura:if isTrue="{!greaterthan(v.currentPageNum,1)}">
                            <a data-record="{!v.currentPageNum-1}"
                               onclick="{!c.handlePreviousPage}">{!v.currentPageNum-1}</a>
                        </aura:if>
                        <a class="active">{!v.currentPageNum}</a>
                        <aura:if isTrue="{!greaterthanorequal(v.maxPageNum,v.currentPageNum+1)}">
                            <a data-record="{!v.currentPageNum+1}"
                               onclick="{!c.handleNextPage}">{!v.currentPageNum+1}</a>
                        </aura:if>
                        <aura:if isTrue="{!greaterthanorequal(v.maxPageNum,v.currentPageNum+2)}">
                            <a data-record="{!v.currentPageNum+2}"
                               onclick="{!c.handleNextPage}">{!v.currentPageNum+2}</a>
                        </aura:if>
                        <aura:if isTrue="{!greaterthan(v.maxPageNum-2,v.currentPageNum)}">
                            <a class="revertPagination">...</a>
                            <a data-record="{!v.maxPageNum}" onclick="{!c.handleNextPage}">{!v.maxPageNum}</a>
                        </aura:if>
                        <aura:if isTrue="{!greaterthan(v.maxPageNum,v.currentPageNum)}">
                            <a data-record="{!v.currentPageNum+1}" onclick="{!c.handleNextPage}">&raquo;</a>
                        </aura:if>
                    </div>
                </div>
                <aura:iteration items="{!v.myOrders}" var="myOrder" indexVar="ind">
                    <div class="singleOrderContainer">
                        <div class="orderInfo">
                            <fieldset class="slds-form-element slds-form-element_compound slds-form-element_address">
                                <div class="slds-form-element__row ">
                                    <div class="slds-size_3-of-6" >
                                        <div class="slds-form-element">
                                            <label class="slds-form-element__label"
                                                   for="form-element-id-06">{!$Label.c.Order_number}</label>
                                            <div class="slds-form-element__control">
                                                <span>{!myOrder.OrderNumber}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="slds-size_1-of-6 caseBanner" >
                                        <div class="slds-form-element" style="padding-right: 0;">
                                            <label class="slds-form-element__label" style="padding-right: 0;"
                                                   for="form-element-id-06">{!$Label.c.Date_of_purchase}</label>
                                            <div class="slds-form-element__control">
                                                <span>{!myOrder.EffectiveDate}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="slds-size_1-of-6 caseBanner" >
                                        <div class="slds-form-element" style="padding-right: 0;">
                                            <label class="slds-form-element__label" style="padding-right: 0;"
                                                   for="form-element-id-06">{!$Label.c.Total_cost}</label>
                                            <div class="slds-form-element__control">
                                                <span>{!myOrder.TotalAmount}$</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="slds-size_1-of-6 caseBanner" >
                                        <div class="slds-form-element" style="padding-right: 0;">
                                            <label class="slds-form-element__label" style="padding-right: 0;"
                                                   for="form-element-id-06">{!$Label.c.Status}</label>
                                            <div class="slds-form-element__control">
                                                <span>{!myOrder.Status}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>

                        </div>

                        <div id="{!ind+'OrderItem'}" class="itemInfoContainer">
                            <h4 style="padding-top: 10px">{!$Label.c.Ordered_title}</h4>
                            <aura:iteration items="{!myOrder.OrderItems}" var="item">
                                <div class="childContainer">
                                    <span style="padding-right: 5px">
                                        <a data-record="{!item.PricebookEntry.Name}" data-index="{!ind}"
                                           onclick="{!c.handleOrderItemClick}">{!item.PricebookEntry.Name}
                                        </a>:
                                    </span>
                                    <span>
                                        {!item.Quantity}{!$Label.c.Multiply_sign} &nbsp;{!item.UnitPrice}$
                                    </span><br/>
                                    <span class="complaintBtn" onclick="{!c.onOpenCaseForm}" data-record="{!myOrder.Id}"
                                          data-index="{!item.Id}">
                                        <lightning:icon iconName="utility:questions_and_answers" size="small"
                                                        title="Submit complaint"/>
                                    </span>
                                </div>
                            </aura:iteration>
                        </div>
                        <div class="orderReel">
                            <div id="{!ind+'OrderArrow'}" class="downIcoContainer" onclick="{!c.handleRollOrder}" data-index="{!ind}">
                                <lightning:icon iconName="utility:down" size="small"/>
                            </div>
                        </div>
                    </div>
                </aura:iteration>
            </lightning:tab>
            <lightning:tab label="{!$Label.c.Complaints_tab}" id="complaints" onactive="{!c.onSearchForUserComplaints}">
                <div class="casesContainer">
                    <aura:iteration items="{!v.complaints}" var="complaint" indexVar="ind">
                        <div class="caseContainer">
                            <fieldset class="slds-form-element slds-form-element_compound slds-form-element_address" style="border-bottom: 1px solid gainsboro;">
                                <div class="slds-form-element__row ">
                                    <div class="slds-size_3-of-6" >
                                        <div class="slds-form-element">
                                            <label class="slds-form-element__label"
                                                   for="form-element-id-06">Subject</label>
                                            <div class="slds-form-element__control">
                                                <span>{!complaint.Subject}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="slds-size_1-of-6 caseBanner">
                                        <div class="slds-form-element" style="padding-right: 0;">
                                            <label class="slds-form-element__label" style="padding-right: 0;"
                                                   for="form-element-id-06">Status</label>
                                            <div class="slds-form-element__control">
                                                <span>{!complaint.Status}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="slds-size_1-of-6 caseBanner" >
                                        <div class="slds-form-element" style="padding-right: 0;">
                                            <label class="slds-form-element__label" style="padding-right: 0;"
                                                   for="form-element-id-06">Case number</label>
                                            <div class="slds-form-element__control">
                                                <span>{!complaint.CaseNumber}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="slds-size_1-of-6 caseBanner" >
                                        <div class="slds-form-element" style="padding-right: 0;">
                                            <label class="slds-form-element__label" style="padding-right: 0;"
                                                   for="form-element-id-06">Case date</label>
                                            <div class="slds-form-element__control">
                                                <span>{!complaint.CreatedDate}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>
                            <div id="{!ind+'CaseItem'}" class="caseInfo">
                                <div class="statusContainer">
                                    <aura:if isTrue="{!complaint.Histories==undefined}">
                                       <div style="text-align: center; font-size: 140%; font-style: italic; padding-top: 4.5rem; color: gray;">
                                           Pending case
                                       </div>
                                    </aura:if>
                                    <aura:if isTrue="{!complaint.Histories!=undefined}">
                                        <label class="slds-form-element__label" for="form-element-id-06">Status history</label>
                                        <table class="slds-table slds-table_cell-buffer slds-table_bordered" id="dataTable" >
                                            <thead>
                                            <tr class="slds-line-height_reset">
                                                <th class="slds-text-title_caps" scope="col">
                                                    <div class="slds-truncate" title="Old status">Old status</div>
                                                </th>
                                                <th class="slds-text-title_caps" scope="col">
                                                    <div class="slds-truncate" title="New status">New status</div>
                                                </th>
                                                <th class="slds-text-title_caps" scope="col">
                                                    <div class="slds-truncate" title="Date">Date</div>
                                                </th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                                <aura:iteration items="{!complaint.Histories.records}" var="caseHistory">
                                                    <tr class="slds-hint-parent">
                                                        <td data-label="{!caseHistory.OldValue}" scope="row">
                                                            <div class="slds-truncate" title="{!caseHistory.OldValue}" >
                                                                    {!caseHistory.OldValue}
                                                            </div>
                                                        </td>
                                                        <td data-label="{!caseHistory.NewValue}">
                                                            <div class="slds-truncate" title="{!caseHistory.NewValue}">
                                                                    {!caseHistory.NewValue}
                                                            </div>
                                                        </td>
                                                        <td data-label="{!caseHistory.CreatedDate}">
                                                            <div class="slds-truncate" title="{!caseHistory.CreatedDate}">{!caseHistory.CreatedDate}</div>
                                                        </td>
                                                    </tr>
                                                </aura:iteration>
                                            </tbody>
                                        </table>
                                    </aura:if>
                                </div>
                                <div class="caseProductInfoContainer">
                                    <label class="slds-form-element__label" for="form-element-id-06">Product</label>
                                    <div class="slds-form-element__control">
                                        <span>
                                            <a onclick="{!c.handleCaseItemClick}" data-record="{!complaint.Order_Product__r.Product2.Name}" data-index="{!ind}">
                                                    {!complaint.Order_Product__r.Product2.Name}
                                            </a>
                                        </span>
                                    </div>
                                    <label class="slds-form-element__label" for="form-element-id-06">Cost</label>
                                    <div class="slds-form-element__control">
                                        <span>{!complaint.Order_Product__r.UnitPrice}$</span>
                                    </div>
                                    <label class="slds-form-element__label" for="form-element-id-06">Order</label>
                                    <div class="slds-form-element__control">
                                        <span>{!complaint.Order__r.OrderNumber}</span>
                                    </div>
                                    <label class="slds-form-element__label" for="form-element-id-06">Order date</label>
                                    <div class="slds-form-element__control">
                                        <span>{!complaint.Order__r.CreatedDate}</span>
                                    </div>
                                </div>
                                <div class="caseMoreInfo">
                                    <label class="slds-form-element__label" for="form-element-id-06">Description</label>
                                    <div class="slds-form-element__control">
                                        <span>{!complaint.Description}</span>
                                    </div>
                                </div>
                                <div class="caseEmailsContainer">
                                    <label class="slds-form-element__label" for="form-element-id-06">Messages</label>
                                    <aura:iteration items="{!complaint.EmailMessages.records}" var="caseEmailMessage">
                                        <div class="slds-form-element__control singleEmail" >
                                            <div class="emailContent">
                                                {!caseEmailMessage.CreatedBy.Name} &nbsp; {!caseEmailMessage.CreatedDate}
                                            </div>
                                            <ui:outputTextArea aura:id="outputRT" value="{!caseEmailMessage.TextBody}" />
                                        </div>
                                    </aura:iteration>
                                </div>
                            </div>
                            <div class="caseReel">
                                <div id="{!ind+'CaseArrow'}" class="downIcoContainer" onclick="{!c.handleRollCase}" data-index="{!ind}" data-record="{!complaint.Id}">
                                    <lightning:icon iconName="utility:down" size="small"/>
                                </div>
                            </div>
                        </div>
                    </aura:iteration>
                </div>
            </lightning:tab>
        </lightning:tabset>

        <c:BM_CaseForm aura:id="newCaseForm"/>
    </div>
</aura:component>